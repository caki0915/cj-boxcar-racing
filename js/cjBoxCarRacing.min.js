var Game={AXIS:{NONE:0,HORIZONTAL:1,VERTICAL:2,BOTH:3},GAMESTATE:{MENU:0,RUNNING:1,PAUSED:2,GAMEOVER:3},CAMERA_SPEED:1,DEFAULT_GRAVITY:7,BOX2D_SCALE:25,b2Vec2:Box2D.Common.Math.b2Vec2,b2Math:Box2D.Common.Math.b2Math,b2AABB:Box2D.Collision.b2AABB,b2BodyDef:Box2D.Dynamics.b2BodyDef,b2Body:Box2D.Dynamics.b2Body,b2FixtureDef:Box2D.Dynamics.b2FixtureDef,b2Fixture:Box2D.Dynamics.b2Fixture,b2World:Box2D.Dynamics.b2World,b2MassData:Box2D.Collision.Shapes.b2MassData,b2PolygonShape:Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape:Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw:Box2D.Dynamics.b2DebugDraw,b2MouseJointDef:Box2D.Dynamics.Joints.b2MouseJointDef,b2PrismaticJointDef:Box2D.Dynamics.Joints.b2PrismaticJointDef,b2RevoluteJointDef:Box2D.Dynamics.Joints.b2RevoluteJointDef,b2ContactListener:Box2D.Dynamics.b2ContactListener,IMG_SMOKE:"smoke1_30"};Game.Game2D=Class.create({screens:{introScreen:function(e){"use strict";var t=document.createElement("h2"),n=document.createElement("p"),r=function(){game.screenManager.setScreen(game.screens.menuScreen)};t.innerHTML="Box-Car Racer";n.innerHTML="Click to start!";t.onclick=r;n.onclick=r;e.appendChild(t);e.appendChild(n)},menuScreen:function(e){"use strict";var t=document.createElement("h2"),n=document.createElement("p"),r=document.createElement("p");t.innerHTML="Box-Car Racer";n.innerHTML="New Game";r.innerHTML="About this game";n.onclick=function(){game.screenManager.setScreen(game.screens.levelScreen)};r.onclick=function(){game.screenManager.setScreen(game.screens.aboutScreen)};e.appendChild(t);e.appendChild(n);e.appendChild(r)},levelScreen:function(e){"use strict";var t=document.createElement("h2"),n=document.createElement("ul");t.innerHTML="Select Level";game.levels.each(function(e){var t=document.createElement("li");t.innerHTML=e.title;t.onclick=function(){game.loadLevel(e.name)};n.appendChild(t)});e.appendChild(t);e.appendChild(n)},loadingScreen:function(e){"use strict";var t=document.createElement("h2");t.innerHTML="Loading..";e.appendChild(t)},inGameScreen:function(e){"use strict";var t=document.createElement("h2"),n=document.createElement("p"),r=document.createElement("p");t.innerHTML="Paused";n.innerHTML="Resume Game";r.innerHTML="Exit to Menu";n.onclick=game.resumeGame;r.onclick=game.exitGame;e.appendChild(t);e.appendChild(n);e.appendChild(r)},gameOverScreen:function(e){"use strict";var t=document.createElement("h2"),n=document.createElement("p"),r=document.createElement("p");t.innerHTML="Game Over!";n.innerHTML="Restart Level";r.innerHTML="Exit to Menu";n.onclick=game.restartGame;r.onclick=game.exitGame;e.appendChild(t);e.appendChild(n);e.appendChild(r)},gameSuccessScreen:function(e){"use strict";var t=document.createElement("h2"),n=document.createElement("p"),r=document.createElement("p");t.innerHTML="You won the level! <br> Score: "+game.currentLevel.score;n.innerHTML="Restart Level";r.innerHTML="Exit to Menu";n.onclick=game.restartGame;r.onclick=game.exitGame;e.appendChild(t);e.appendChild(n);e.appendChild(r)},aboutScreen:function(e){"use strict";var t=document.createElement("h2"),n=document.createElement("span"),r=document.createElement("p");t.innerHTML="About this game";n.innerHTML="Box-Car Racer is a 2D Game & Game-engine with <br> Javscript, HTML5, TMX-maps & Box2D-physics <br> created by <br> Carl-Johan Kihl 2013";r.innerHTML="Back";r.onclick=function(){game.screenManager.setScreen(game.screens.menuScreen)};e.appendChild(t);e.appendChild(n);e.appendChild(r)}},initialize:function(e){"use strict";this.canvas=e.canvas;this.ct=e.canvas.getContext("2d");this.debug=e.debug;if(this.debug===undefined){this.debug=false}this.gui=e.gui;this.debug_ct=e.debug_canvas.getContext("2d");this.resourceUrl=e.resourceUrl||null;this.levels=e.levels||null;this.events=e.events||{};this.startOptions=e;this.gamestate=Game.GAMESTATE.MENU;this.screenManager=new Game.ScreenManager({gui:this.gui,levels:this.levels});window.addEventListener("keypress",function(e){if(e.which===112||e.charCode===112){if(Game.GAMESTATE.RUNNING===game.gamestate){game.pauseGame()}else if(Game.GAMESTATE.PAUSED===game.gamestate){game.resumeGame()}}},false);this.screenManager.setScreen(this.screens.introScreen).show()},loadLevel:function(e){"use strict";game.screenManager.setScreen(game.screens.loadingScreen);Game.TMXJsonReader.loadAsync(this.resourceUrl+"/levels/"+e+".json",{onSuccess:function(t){t.name=e;t.resources.images[Game.IMG_SMOKE]=game.resourceUrl+"/images/smoke1_30.png";console.log("Level created, Loading resources..");t.loadResources(function(){game.screenManager.hide();if(game.events.onLoaded!==undefined){game.events.onLoaded()}game.currentLevel=t;game.resumeGame()})},onProgress:function(e,t){console.log("Loading: "+e+" ## Message: "+t)}})},gameLoop:function(){"use strict";var e=Date.now(),t=e-(game.lastGameTick||e);game.lastGameTick=e;game.ct.clearRect(0,0,game.canvas.width,game.canvas.height);if(game.events.onUpdate!==undefined){game.events.onUpdate()}if(game.currentLevel!==null){game.currentLevel.update(t);game.currentLevel.render(game.ct,game.camera);if(game.debug){game.currentLevel.debugRender(game.debug_ct,game.camera)}}if(game.gamestate===Game.GAMESTATE.RUNNING){window.setTimeout(game.gameLoop,1e3/60)}else{console.log("game stopped")}},pauseGame:function(){"use strict";game.gamestate=Game.GAMESTATE.PAUSED;this.screenManager.setScreen(game.screens.inGameScreen).show()},resumeGame:function(){"use strict";if(game.gamestate===Game.GAMESTATE.GAMEOVER){return}game.gamestate=Game.GAMESTATE.RUNNING;game.screenManager.hide();game.gameLoop()},gameOver:function(){"use strict";game.gamestate=Game.GAMESTATE.GAMEOVER;this.screenManager.setScreen(game.screens.gameOverScreen).show()},gameSuccess:function(){"use strict";game.gamestate=Game.GAMESTATE.GAMEOVER;this.screenManager.setScreen(game.screens.gameSuccessScreen).show()},restartGame:function(){"use strict";game.gamestate=Game.GAMESTATE.MENU;game.loadLevel(game.currentLevel.name)},exitGame:function(){"use strict";game.currentLevel=null;game.gamestate=Game.GAMESTATE.MENU;game.screenManager.setScreen(game.screens.menuScreen).show()}});window.requestAnimFrame=function(){"use strict";return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();window.cancelRequestAnimFrame=function(){"use strict";return window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.clearTimeout}();window.Key={pressed:{},LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,A:65,S:83,D:68,W:87,ENTER:13,ESCAPE:27,P:80,R:82,isDown:function(e,t){"use strict";return this.pressed[e]||this.pressed[t]},onKeydown:function(e){"use strict";this.pressed[e.keyCode]=true},onKeyup:function(e){"use strict";delete this.pressed[e.keyCode]}};window.addEventListener("keyup",function(e){"use strict";window.Key.onKeyup(e)},false);window.addEventListener("keydown",function(e){"use strict";if(e.keyCode===32){e.preventDefault()}window.Key.onKeydown(e)},true);Game.setTimeout=function(e,t){"use strict";var n=this,r=Array.prototype.slice.call(arguments,2);return window.setInterval(e instanceof Function?function(){e.apply(n,r)}:e,t)};Number.prototype.clamp=function(e,t){"use strict";return Math.min(Math.max(this,e),t)};Game.Camera=Class.create({deadzone:{x:0,y:0,width:0,height:0},limit:{x:0,y:0,width:0,height:0},target:null,followAxis:Game.AXIS.BOTH,initialize:function(e,t,n){"use strict";this.x=0;this.y=n.height-t;this.width=e;this.height=t;this.limit.width=n.width-e;this.limit.height=n.height-t;this.setDeadzone(300,200,300,400)},move:function(e,t){"use strict";var n=this.x+e,r=this.y+t;this.x=~~n.clamp(this.limitX,this.limitWidth);this.y=~~r.clamp(this.limitY,this.limitHeight)},update:function(e){"use strict";if(this.target!==null){switch(this.followAxis){case Game.AXIS.VERTICAL:this._followV(this.target);break;case Game.AXIS.HORIZONTAL:this._followH(this.target);break;case Game.AXIS.BOTH:this._followV(this.target);this._followH(this.target);break}}},setDeadzone:function(e,t,n,r){"use strict";this.deadzone.x=~~((this.width-n)/2);this.deadzone.y=~~((this.height-e)/2-this.height*.25);this.deadzone.width=this.width-r;this.deadzone.height=this.height-t},_followH:function(e){"use strict";if(e.x-this.x>this.deadzone.width){this.x=~~Math.min(e.x-this.deadzone.width,this.limit.width)}else if(e.x-this.x<this.deadzone.x){this.x=~~Math.max(e.x-this.deadzone.x,0)}},_followV:function(e){"use strict";if(e.y-this.y>this.deadzone.height){this.y=~~Math.min(e.y-this.deadzone.height,this.limit.height)}else if(e.y-this.y<this.deadzone.y){this.y=~~Math.max(e.y-this.deadzone.y,-200)}}});Game.Level=Class.create({initialize:function(e){"use strict";this.width=e.width||null;this.height=e.height||null;this.resources={images:e.images||{},sounds:e.sounds||{}};this.layers=[];this.backgrounds=[];this.renderedsprites=0;this.world=new Game.b2World(new Game.b2Vec2(0,Game.DEFAULT_GRAVITY),true);this.score=0;var t=new Game.b2ContactListener;t.PostSolve=function(e,t){var n=e.GetFixtureA().GetBody().GetUserData(),r=e.GetFixtureB().GetBody().GetUserData(),i=e.GetManifold().m_pointCount,s,o;if(n===r){return}if(n!==null||r!==null){if(n!==null&&r!==null&&(n.type==="exit"&&r.type==="vehicle"||r.type==="exit"&&n.type==="vehicle")){game.gameSuccess()}s=0;for(o=0;o<i;o++){s=Game.b2Math.Max(s,t.normalImpulses[o])}if(s<1.8){return}if(n!==null&&n.entity!==null&&n.entity.breakable===true){n.entity.damage-=s}if(r!==null&&r.entity!==null&&r.entity.breakable===true){r.entity.damage-=s}}};this.world.SetContactListener(t)},loadResources:function(e){"use strict";var t=this.resources.images,n=0,r,i,s=function(){n--;console.log(n+" images left to load");if(n<=0){console.log("All images are loaded");if(typeof e==="function"){e()}}},o=function(){console.log("image load error")};this.resources.images={};console.log(t);for(r in t){if(t.hasOwnProperty(r)){n++}}for(r in t){if(t.hasOwnProperty(r)){console.log(r);i=new Image;i.id=r;i.onload=s;i.onerror=o;i.src=t[r];this.resources.images[r]=i}}},render:function(e){"use strict";var t,n,r,i,s,o,u,a,f;e.clearRect(0,0,this.width,this.height);this.renderedSprites=0;for(r=0;r<this.backgrounds.length;r++){t=this.backgrounds[r];n=this.resources.images[t.image];i=n.width*t.scaleX;s=n.height*t.scaleY;for(o=0;o<this.camera.width+i;o+=i){u=~~(this.camera.x*t.pX%i);e.drawImage(this.resources.images[t.image],u+o,0,i,s);if(t.repeatX===false){break}}}e.save();e.translate(-this.camera.x,-this.camera.y);for(r=0;r<this.layers.length;r++){for(a=0;a<this.layers[r].entities.length;a++){f=this.layers[r].entities[a];if(f.removed===true){this.layers[r].entities.splice(a,1);a--}f.render(e,this);this.renderedSprites++}}e.restore();e.font="48px Arial";e.fillText(~~this.score,100,100)},update:function(e){"use strict";this.world.Step(1/30,10,10);this.world.ClearForces();this.camera.update(e)},debugRender:function(e){"use strict";e.clearRect(0,0,this.camera.width,this.camera.height);if(this.b2DebugDraw===undefined){this.b2DebugDraw=new Game.b2DebugDraw;this.b2DebugDraw.SetSprite(e);this.b2DebugDraw.SetDrawScale(Game.BOX2D_SCALE);this.b2DebugDraw.SetFillAlpha(.6);this.b2DebugDraw.SetLineThickness(1);this.b2DebugDraw.SetFlags(Game.b2DebugDraw.e_shapeBit|Game.b2DebugDraw.e_jointBit);this.world.SetDebugDraw(this.b2DebugDraw)}e.save();e.translate(-this.camera.x,-this.camera.y);this.world.DrawDebugData();e.restore()}});Game.ScreenManager=Class.create({initialize:function(e){"use strict";this.gui=e.gui;this.levels=e.levels},setScreen:function(e){"use strict";this.gui.innerHTML="";e(this.gui);return this},hide:function(){"use strict";$(this.gui).hide();return this},show:function(){"use strict";$(this.gui).show();return this}});Game.TMXJsonReader=function(){"use strict";var t="resources",n=function(e,n){t=game.resourceUrl;new Ajax.Request(e,{method:"get",onSuccess:function(e){var t,s,u=e.responseText.evalJSON(),a=new Game.Level({width:u.width*u.tilewidth,height:u.height*u.tileheight,images:r(u)});for(t=0;t<u.layers.length;t++){s=u.layers[t];if(s.type==="imagelayer"){a.backgrounds.push(o(s))}if(s.type==="tilelayer"){s=i(u,s,a);a.layers.push(s)}}if(n.onSuccess!==undefined){n.onSuccess(a)}}})},r=function(e){var n={},r,i;for(r=0;r<e.layers.length;r++){if(e.layers[r].type==="imagelayer"){i=e.layers[r];n[i.name]=t+"/images/"+i.image.substring(i.image.lastIndexOf("/")+1)}}for(r=0;r<e.tilesets.length;r++){i=e.tilesets[r];n[i.name]=t+"/tilemaps/"+i.image.substring(i.image.lastIndexOf("/")+1)}return n},i=function(e,t,n){var r=[],i=[],o,u,a=new Game.b2FixtureDef,f=new Game.b2BodyDef,l,c=0,h,p,d,v,m,g,y,b,w;a.shape=new Game.b2PolygonShape;for(y=0;y<t.data.length;y++){if(t.data[y]===0){continue}for(b=1;b<e.tilesets.length;b++){if(t.data[y]<e.tilesets[b].firstgid){break}c=b}l=e.tilesets[c];p=~~(l.imagewidth/(l.tilewidth+l.spacing));v=t.data[y]-1;d=v-l.firstgid+1;u=null;if(l.tileproperties!==undefined&&l.tileproperties[v]!==undefined){o=l.tileproperties[v];if(o.type!==undefined){u=o.type}}h=new Game.Sprite({},n);h.image=l.name;h.width=l.tilewidth;h.height=l.tileheight;m=y%t.width;g=(y-m)/t.width;h.sourceX=d%p;h.sourceY=~~((d-h.sourceX)/p);h.x=m*e.tilewidth;h.y=g*e.tileheight-e.tileheight;h.sourceX*=l.tilewidth+l.spacing;h.sourceY*=l.tileheight+l.spacing;h.sourceWidth=l.tilewidth;h.sourceHeight=l.tileheight;if(u!==null){switch(u){case"start":h=new Game.Vehicle(Object.extend({x:h.x,y:h.y},o),n);n.camera=new Game.Camera(game.canvas.width,game.canvas.height,n);n.camera.target=h;break;case"exit":f.type=Game.b2Body.b2_staticBody;a.shape.SetAsBox(h.width/Game.BOX2D_SCALE/2,h.height/Game.BOX2D_SCALE/2);a.isSensor=false;f.position.Set((h.x+h.width/2)/Game.BOX2D_SCALE,(h.y+h.height/2)/Game.BOX2D_SCALE);w=n.world.CreateBody(f);w.SetUserData({type:"exit",entity:null});w.CreateFixture(a);break;case"box":h=new Game.Box(h,o,n);break;case"platform":if(i[g]===undefined){i[g]=[]}i[g][m]=true;break;case"solid.315":f.type=Game.b2Body.b2_staticBody;a.isSensor=false;a.shape.SetAsArray([new Game.b2Vec2(0,h.height/Game.BOX2D_SCALE),new Game.b2Vec2(h.width/Game.BOX2D_SCALE,0),new Game.b2Vec2(h.width/Game.BOX2D_SCALE,h.height/Game.BOX2D_SCALE)],3);f.position.Set(h.x/Game.BOX2D_SCALE,h.y/Game.BOX2D_SCALE);n.world.CreateBody(f).CreateFixture(a);break;case"solid.45":f.type=Game.b2Body.b2_staticBody;a.isSensor=false;a.shape.SetAsArray([new Game.b2Vec2(0,h.height/Game.BOX2D_SCALE),new Game.b2Vec2(0,0),new Game.b2Vec2(h.width/Game.BOX2D_SCALE,h.height/Game.BOX2D_SCALE)],3);f.position.Set(h.x/Game.BOX2D_SCALE,h.y/Game.BOX2D_SCALE);n.world.CreateBody(f).CreateFixture(a);break}}r.push(h)}s(i,e,n.world);return{entities:r}},s=function(e,t,n){var r=new Game.b2FixtureDef,i=new Game.b2BodyDef,s,o;i.type=Game.b2Body.b2_staticBody;r.shape=new Game.b2PolygonShape;r.shape.SetAsBox(t.tilewidth/Game.BOX2D_SCALE,.1);for(s=0;s<e.length;s++){if(e[s]!==undefined){for(o=0;o<e[s].length;o++){if(e[s][o]!==undefined){i.position.Set((o*t.tilewidth+t.tilewidth)/Game.BOX2D_SCALE,(s*t.tileheight-t.tileheight+3)/Game.BOX2D_SCALE);n.CreateBody(i).CreateFixture(r)}}}}},o=function(e){var t=e.properties||{};t.pX=t.pX||0;t.pY=t.pY||0;if(t.repeatX===undefined){t.repeatX=true}if(t.repeatY===undefined){t.repeatY=false}t.scaleX=t.scaleX||1;t.scaleY=t.scaleY||1;t.image=e.name;return t};return{loadAsync:n}}();Game.AnimatedSprite=Class.create({initialize:function(e,t){"use strict";this.x=e.x||0;this.y=e.y||0;this.width=e.width||0;this.height=e.height||0;this.sx=e.sx||1;this.sy=e.sy||1;this.animationSpeed=e.animationSpeed||1;this.loop=e.loop;if(this.loop===undefined){this.loop=true}this.sourceX=0;this.sourceY=0;this.image=e.image||null;this.sourceWidth=0;this.sourceHeight=0;this.currentFrame=0;this.removed=false;this.level=t},render:function(e){"use strict";var t=this.level.resources.images[this.image],n=~~this.currentFrame;t.width=1536;t.height=1279;if(this.sourceWidth===0){this.sourceWidth=~~(t.width/this.sx);this.sourceHeight=~~(t.height/this.sy)}this.sourceX=n%this.sx;this.sourceY=~~((n-this.sourceX)/this.sx);e.drawImage(t,this.sourceX*this.sourceWidth,this.sourceY*this.sourceHeight,this.sourceWidth,this.sourceHeight,this.x-this.width/2,this.y-this.height/2,this.width,this.height);this.currentFrame+=this.animationSpeed;if(this.currentFrame>=this.sx*this.sy){if(this.loop===false){this.removed=true}this.currentFrame=0}}});Game.Sprite=Class.create({initialize:function(e,t){"use strict";this.x=e.x||0;this.y=e.y||0;this.width=e.width||0;this.height=e.height||0;this.image=e.image||null;this.sourceX=e.sourceX||0;this.sourceY=e.sourceY||0;this.sourceWidth=e.sourceWidth||0;this.sourceHeight=e.sourceHeight||0;this.removed=false;this.level=t},render:function(e){"use strict";e.drawImage(this.level.resources.images[this.image],this.sourceX,this.sourceY,this.sourceWidth,this.sourceHeight,this.x,this.y,this.width,this.height)}});Game.Box=Class.create({initialize:function(e,t,n){"use strict";this.sprite=e;this.bonus=parseInt(t.bonus,10)||100;this.damage=t.damage||100;this.breakable=t.breakable||true;this.level=n;this.removed=false;var r=new Game.b2FixtureDef,i=new Game.b2BodyDef;i.position.Set((this.sprite.x+this.sprite.width/2)/Game.BOX2D_SCALE,this.sprite.y/Game.BOX2D_SCALE);i.type=Game.b2Body.b2_dynamicBody;r.density=.1;r.friction=.5;r.restitution=.5;r.shape=new Game.b2PolygonShape(1);r.shape.SetAsBox(e.width/Game.BOX2D_SCALE/2,e.height/Game.BOX2D_SCALE/2);i.userData={type:"box",entity:this};this.body=n.world.CreateBody(i);this.body.CreateFixture(r);this.body.SetFixedRotation(false);this.sprite.x=-this.sprite.width/2;this.sprite.y=-this.sprite.height/2},render:function(e){"use strict";if(this.damage<=0){this.level.world.DestroyBody(this.body);this.removed=true;this.level.layers[0].entities.push(new Game.AnimatedSprite({x:this.position.x*Game.BOX2D_SCALE,y:this.position.y*Game.BOX2D_SCALE,width:200,height:200,image:Game.IMG_SMOKE,sx:6,sy:5,loop:false},this.level));game.currentLevel.score+=this.bonus}else{this.position=this.body.GetWorldCenter();e.save();e.translate(this.position.x*Game.BOX2D_SCALE,this.position.y*Game.BOX2D_SCALE);e.rotate(this.body.GetAngle());this.sprite.render(e);e.font="24px Arial";e.fillStyle="blue";e.fillText(~~this.damage,-25,0);e.restore()}}});Game.Vehicle=Class.create({options:null,canRotate:true,cart:null,spring1:null,spring2:null,motor1:null,motor2:null,WHEEL_IMAGE:"vehicle_wheel",BODY_IMAGE:"vehicle_body",initialize:function(e,t){"use strict";e.x=e.x||4;e.y=e.y||15;e.width=e.width||3.4*Game.BOX2D_SCALE;e.height=e.height||.6*Game.BOX2D_SCALE;e.axle_x=e.axle_x||1.3;e.axle2_x=e.axle2_x||1.6;e.axle_y=e.axle_y||.3;e.axle_height=e.axle_height||.3;e.axle_width=e.axle_width||.15;e.wheel_radius=e.wheel_radius||.9;e.cart_img_width=1.8*50;e.cart_img_height=.7*50;this.options=e;this.level=t;t.resources.images[this.WHEEL_IMAGE]=game.resourceUrl+"/images/vehicle/wheel_1.png";t.resources.images[this.BODY_IMAGE]=game.resourceUrl+"/images/vehicle/truck_1.png";var n=new Game.b2BodyDef,r=new Game.b2FixtureDef,i=new Game.b2FixtureDef,s=new Game.b2PrismaticJointDef,o=new Game.b2RevoluteJointDef,u,a,f={type:"vehicle",entity:this},l;n.type=Game.b2Body.b2_dynamicBody;n.position.Set(e.x/Game.BOX2D_SCALE,e.y/Game.BOX2D_SCALE);this.cart=t.world.CreateBody(n);r.density=.5;r.friction=.5;r.restitution=.2;r.filter.groupIndex=-1;r.shape=new Game.b2PolygonShape;r.shape.SetAsArray([new Game.b2Vec2(-.5,-.6),new Game.b2Vec2(-.5,-1.4),new Game.b2Vec2(1.2,-1.4),new Game.b2Vec2(1.2,-.6)],4);this.cart.CreateFixture(r);r.shape.SetAsBox(e.width/Game.BOX2D_SCALE,e.height/Game.BOX2D_SCALE);this.cart.CreateFixture(r);this.cart.SetUserData(f);r.shape=new Game.b2PolygonShape;r.shape.SetAsOrientedBox(e.axle_height,e.axle_width,new Game.b2Vec2(-e.axle_x,e.axle_y),-Math.PI/3);this.cart.CreateFixture(r);r.shape.SetAsOrientedBox(e.axle_height,e.axle_width,new Game.b2Vec2(e.axle2_x,e.axle_y),Math.PI/3);this.cart.CreateFixture(r);this.cart.SetAngularDamping(20);r.density=1;u=t.world.CreateBody(n);r.shape.SetAsOrientedBox(e.axle_height,.1,new Game.b2Vec2(-e.axle_x-Math.cos(Math.PI/3),e.axle_y+Math.sin(Math.PI/3)),-Math.PI/3);u.CreateFixture(r);s.lowerTranslation=-.3;s.upperTranslation=.5;s.enableLimit=true;s.enableMotor=true;s.Initialize(this.cart,u,u.GetWorldCenter(),new Game.b2Vec2(-Math.cos(Math.PI/3),Math.sin(Math.PI/3)));this.spring1=t.world.CreateJoint(s);a=t.world.CreateBody(n);r.shape.SetAsOrientedBox(e.axle_height,.1,new Game.b2Vec2(e.axle2_x+Math.cos(Math.PI/3),e.axle_y+Math.sin(Math.PI/3)),Math.PI/3);a.CreateFixture(r);s.Initialize(this.cart,a,a.GetWorldCenter(),new Game.b2Vec2(Math.cos(Math.PI/3),Math.sin(Math.PI/3)));this.spring2=t.world.CreateJoint(s);i.density=.1;i.friction=5;i.restitution=.2;i.filter.groupIndex=-1;i.shape=new Game.b2CircleShape(e.wheel_radius);for(l=0;l<2;l++){n=new Game.b2BodyDef;n.type=Game.b2Body.b2_dynamicBody;if(l===0){n.position.Set(u.GetWorldCenter().x-e.axle_height*Math.cos(Math.PI/3),u.GetWorldCenter().y+e.axle_height*Math.sin(Math.PI/3))}else{n.position.Set(a.GetWorldCenter().x+e.axle_height*Math.cos(-Math.PI/3),a.GetWorldCenter().y+e.axle_height*Math.sin(Math.PI/3))}n.allowSleep=false;if(l===0){this.wheel1=t.world.CreateBody(n);this.wheel1.SetUserData(f)}else{this.wheel2=t.world.CreateBody(n);this.wheel2.SetUserData(f)}(l===0?this.wheel1:this.wheel2).CreateFixture(i)}o.enableMotor=true;o.Initialize(u,this.wheel1,this.wheel1.GetWorldCenter());this.motor1=t.world.CreateJoint(o);this.motor1.EnableMotor(true);o.Initialize(a,this.wheel2,this.wheel2.GetWorldCenter());this.motor2=t.world.CreateJoint(o);this.motor2.EnableMotor(true)},render:function(e){"use strict";this.update();var t=this.cart.GetFixtureList(),n=this.options.wheel_radius*Game.BOX2D_SCALE;e.strokeStyle="#000";e.lineWidth=3;e.fillStyle="#AAA";e.beginPath();this.drawFixture(e,t);t=t.GetNext();this.drawFixture(e,t);e.closePath();e.stroke();e.fill();this.tempVec=this.cart.GetWorldCenter();e.save();e.translate(this.tempVec.x*Game.BOX2D_SCALE,this.tempVec.y*Game.BOX2D_SCALE);e.rotate(this.cart.GetAngle());e.drawImage(this.level.resources.images[this.BODY_IMAGE],-this.options.cart_img_width,-this.options.cart_img_height,this.options.cart_img_width*2,this.options.cart_img_height*2);e.restore();this.tempVec=this.wheel1.GetWorldCenter();e.save();e.translate(this.tempVec.x*Game.BOX2D_SCALE,this.tempVec.y*Game.BOX2D_SCALE);e.rotate(this.wheel1.GetAngle());e.drawImage(this.level.resources.images[this.WHEEL_IMAGE],-n,-n,n*2,n*2);e.restore();this.tempVec=this.wheel2.GetWorldCenter();e.save();e.translate(this.tempVec.x*Game.BOX2D_SCALE,this.tempVec.y*Game.BOX2D_SCALE);e.rotate(this.wheel2.GetAngle());e.drawImage(this.level.resources.images[this.WHEEL_IMAGE],-n,-n,n*2,n*2);e.restore()},tempVec:new Game.b2Vec2,tempVec2:new Game.b2Vec2,drawFixture:function(e,t){"use strict";var n=t.GetShape(),r=n.GetVertices(),i;this.tempVec2=this.cart.GetWorldPoint(r[0]);e.moveTo(this.tempVec2.x*Game.BOX2D_SCALE,this.tempVec2.y*Game.BOX2D_SCALE);for(i=1;i<r.length;i++){this.tempVec=this.cart.GetWorldPoint(r[i]);e.lineTo(this.tempVec.x*Game.BOX2D_SCALE,this.tempVec.y*Game.BOX2D_SCALE)}e.lineTo(this.tempVec2.x*Game.BOX2D_SCALE,this.tempVec2.y*Game.BOX2D_SCALE)},update:function(){"use strict";if(this.tempVec.y*Game.BOX2D_SCALE>this.level.height+300){game.gameOver()}this.tempVec=this.cart.GetPosition();this.x=this.tempVec.x*Game.BOX2D_SCALE;this.y=this.tempVec.y*Game.BOX2D_SCALE;this.motor1.SetMotorSpeed(15*Math.PI*(Key.isDown(Key.W)?1:Key.isDown(Key.S)?-1:0));this.motor1.SetMaxMotorTorque(Key.isDown(Key.W)||Key.isDown(Key.S)?17:.5);this.motor2.SetMotorSpeed(15*Math.PI*(Key.isDown(Key.W)?1:Key.isDown(Key.S)?-1:0));this.motor2.SetMaxMotorTorque(Key.isDown(Key.W)||Key.isDown(Key.S)?12:.5);this.spring1.SetMaxMotorForce(30+Math.abs(800*Math.pow(this.spring1.GetJointTranslation(),2)));this.spring1.SetMotorSpeed((this.spring1.GetMotorSpeed()-10*this.spring1.GetJointTranslation())*.4);this.spring2.SetMaxMotorForce(20+Math.abs(800*Math.pow(this.spring2.GetJointTranslation(),2)));this.spring2.SetMotorSpeed(-4*Math.pow(this.spring2.GetJointTranslation(),1));if(window.Key.isDown(Key.SPACE)){this.spring1.SetMaxMotorForce(200);this.spring1.SetMotorSpeed(20);this.spring2.SetMaxMotorForce(200);this.spring2.SetMotorSpeed(20)}var e=this.onRotationReady;if(window.Key.isDown(Key.A)){if(this.canRotate){this.spring1.SetMaxMotorForce(100);this.spring1.SetMotorSpeed(10);this.cart.SetAngularVelocity(5);this.canRotate=false;Game.setTimeout(e,500,this)}}if(window.Key.isDown(Key.D)){if(this.canRotate){this.spring2.SetMaxMotorForce(100);this.spring2.SetMotorSpeed(10);this.cart.SetAngularVelocity(-5);this.canRotate=false;Game.setTimeout(e,500,this)}}},onRotationReady:function(e){"use strict";e.canRotate=true}})